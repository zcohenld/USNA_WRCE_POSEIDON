[include timelapse.cfg]
[include mainsail.cfg]
[include macros.cfg]
[include klicky-probe.cfg]

##--------------------------------------------------------------------
[mcu]

serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_560055000D51313133353932-if00
restart_method: command

[mcu mcu2]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_260038001550335331383520-if00
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu
##--------------------------------------------------------------------

[printer]
kinematics: cartesian
max_velocity: 300  
max_accel: 500
max_z_velocity: 5
max_z_accel: 180
square_corner_velocity: 5.0

#####################################################################
#   X/Y Stepper Settings
#####################################################################

##  Connected to MOTOR_0
[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 20
microsteps: 32
full_steps_per_rotation:200
endstop_pin: !mcu2:PG6
position_min: 0
position_endstop: 1000
position_max: 1000

homing_speed: 50
homing_retract_dist: 5
homing_positive_dir: true
homing_retract_speed: 25
second_homing_speed: 10


##  Connected to MOTOR_1
[stepper_y]
step_pin: PG0
dir_pin: !PG1
enable_pin: !PF15
rotation_distance: 20
microsteps: 32
full_steps_per_rotation:200
endstop_pin: !PG10
position_min: 0
position_endstop: 0
position_max: 925

homing_speed: 50
homing_retract_dist: 5
homing_positive_dir: false
homing_retract_speed: 25
second_homing_speed: 10


##  Connected to MOTOR_2
[stepper_y1]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
rotation_distance: 20
microsteps: 32
full_steps_per_rotation:200
endstop_pin: !PG9

#####################################################################
#   Z Stepper Settings
#####################################################################

##  Connected to MOTOR_3
#front right
[stepper_z]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: .9995840789  
microsteps: 32
full_steps_per_rotation:200
position_max: 840
position_min: -15
homing_speed: 5
second_homing_speed: 3
homing_retract_dist: 3

endstop_pin: PG6
homing_speed: 15
second_homing_speed: 3
homing_retract_dist: 5
#position_endstop: 10.5


[tmc5160 stepper_z]
cs_pin: PC7
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


##  Connected to MOTOR_4
#front left
[stepper_z1]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
rotation_distance: .9995840789
microsteps: 32
full_steps_per_rotation:200

[tmc5160 stepper_z1]
cs_pin: PF2
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


##  Connected to MOTOR_5
#Back left
[stepper_z2]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: .9995840789 
microsteps: 32
full_steps_per_rotation:200

[tmc5160 stepper_z2]
cs_pin: PE4
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


##  Connected to MOTOR_6
#Back right
[stepper_z3]
step_pin: PE2
dir_pin: !PE3
enable_pin: !PD4
rotation_distance: .9995840789 
microsteps: 32
full_steps_per_rotation:200

[tmc5160 stepper_z3]
cs_pin: PE1
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[endstop_phase]


#####################################################################
#   Extruder
#####################################################################

[thermistor Dyze300]
temperature1: 20
resistance1: 123800
temperature2: 200
resistance2: 550
temperature3: 300
resistance3: 106

[extruder]

step_pin: mcu2:PF13
dir_pin: !mcu2:PF12
enable_pin: !mcu2:PF14

rotation_distance: 31.06  #26.5962159825 

gear_ratio: 5.65:1
microsteps: 16
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: mcu2:PA2


sensor_type: Dyze300
sensor_pin: mcu2:PF3
#spi_speed: 4000000
#spi_software_sclk_pin: mcu2:PA5
#spi_software_mosi_pin: mcu2:PA7
#spi_software_miso_pin: mcu2:PA6

#rtd_nominal_r: 106
#rtd_num_of_wires: 2
#rtd_reference_r: 430
#rtd_use_50Hz_filter: False

min_temp: 10
max_temp: 300
max_power: 1.0
min_extrude_temp: 170
#control = pid
#pid_kp = 19.3
#pid_ki = 2.1
#pid_kd = 44.6

pressure_advance: 0.05
pressure_advance_smooth_time: 0.040

##  E0 on mcu2_MOTOR0
[tmc5160 extruder]
cs_pin: mcu2:PC4
interpolate: false
run_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 0

spi_software_miso_pin: mcu2:PA6
spi_software_mosi_pin: mcu2:PA7
spi_software_sclk_pin: mcu2:PA5


#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PA1
sensor_type: ATC Semitec 104GT-2
sensor_pin: mcu2:PF7

max_power: 1.0
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

[verify_heater heater_bed]
heating_gain: 1.25
check_gain_time: 100

#####################################################################
#   Probe
#####################################################################

[probe]
pin: ^mcu2:PG9
x_offset: 38.463
y_offset: 28.624
#z_offset: 0
speed: 5.0
samples: 5
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.1
samples_tolerance_retries: 10

#####################################################################
#   Fan Control
#####################################################################

[fan]
pin: mcu2:PE5
kick_start_time: 0.5
off_below: 0.10

[heater_fan hotend_fan]
pin: mcu2:PA8
max_power: 1
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

#####################################################################
#   Lights
#####################################################################

[heater_fan hotend_light]
pin: mcu2:PD13
heater: extruder
heater_temp: 50

[output_pin caselight]
pin: PA2
pwm:true
shutdown_value: 0
value:0.5
cycle_time: 0.001 

[heater_fan bed_light]
pin: mcu2:PD12
heater: heater_bed
heater_temp: 35

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

[bed_screws]
screw1: 50, 50
screw1_name: front left
screw2: 50, 875
screw2_name: back left
screw3: 950, 875
screw3_name: back right
screw4: 950, 50
screw4_name: front right

speed: 100
horizontal_move_z: 25

[bed_mesh]
mesh_min: 45, 20
mesh_max: 975, 900
algorithm: bicubic
probe_count: 21, 21
horizontal_move_z: 20
zero_reference_position: 500, 500

[z_tilt]
z_positions:
  -162, 150
  -162, 800
  1195, 800
  1195, 150

points:
  25, 150
  25, 800
  800, 800
  800, 150

#points:
#  25, 25
#  25, 900
#  950, 900
#  950, 25

speed: 200
horizontal_move_z: 20
retries: 5
retry_tolerance: 0.6

#####################################################################
#   Additional Sensors
#####################################################################

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100 

[temperature_sensor mcu2_temp]
sensor_type: temperature_mcu
sensor_mcu: mcu2
min_temp: 0
max_temp: 100

[filament_switch_sensor FSS_T0_2]
switch_pin: ^PG13
pause_on_runout: True
runout_gcode:
  M117 Filament Switch Runout

[filament_motion_sensor FSS_T0]
switch_pin: ^PG12
detection_length: 3
extruder: extruder
pause_on_runout: True 
runout_gcode:
  M117 Runout Detected!

[adxl345]
cs_pin: rpi:None

[resonance_tester]
accel_chip: adxl345
probe_points:
    500, 500, 20

[input_shaper]
shaper_freq_x: 44.8
shaper_type_x: zv
shaper_freq_y: 56.2
shaper_type_y: zv

#####################################################################
#   Displays
#####################################################################

#I'll deal with this later (7/6/23)

#--------------------------------------------------------------------

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 71.016
#*# pid_ki = 1.208
#*# pid_kd = 1043.929
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 17.343
#*# pid_ki = 0.605
#*# pid_kd = 124.215
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.399588, 0.341800, 0.366321, 0.327275, 0.368039, 0.367570, 0.393185, 0.416144, 0.438010, 0.425515, 0.355075, 0.310094, 0.232314, 0.129076, 0.022870, -0.067405, -0.139250, -0.217811, -0.318238, -0.304650, -0.328546
#*# 	0.319153, 0.179836, 0.199047, 0.238249, 0.257772, 0.261833, 0.276983, 0.296350, 0.306814, 0.283387, 0.232314, 0.186239, 0.105648, 0.000223, -0.099423, -0.178609, -0.238271, -0.300433, -0.407264, -0.399611, -0.416791
#*# 	0.248870, 0.110021, 0.107366, 0.158595, 0.182960, 0.167653, 0.180304, 0.196235, 0.201858, 0.188114, 0.129232, 0.080502, 0.015842, -0.057097, -0.165021, -0.242801, -0.291218, -0.371810, -0.451776, -0.429286, -0.454744
#*# 	0.181710, 0.054263, 0.025057, 0.080658, 0.098307, 0.091591, 0.087531, 0.115488, 0.112052, 0.096121, 0.029898, -0.001495, -0.049756, -0.137376, -0.214219, -0.283097, -0.328390, -0.405546, -0.479109, -0.457555, -0.456306
#*# 	0.103930, -0.015395, -0.048194, 0.005690, 0.009750, 0.006314, 0.001004, 0.020371, 0.011937, 0.012406, -0.012428, -0.061939, -0.114573, -0.195477, -0.267478, -0.321518, -0.370248, -0.419134, -0.506753, -0.467082, -0.479265
#*# 	0.050515, -0.067405, -0.114260, -0.058659, -0.041791, -0.050068, -0.049912, -0.033357, -0.027734, -0.040229, -0.086460, -0.119102, -0.164708, -0.239365, -0.284346, -0.344477, -0.390083, -0.436002, -0.506441, -0.461304, -0.480046
#*# 	0.002410, -0.131909, -0.152682, -0.113323, -0.097549, -0.092395, -0.094737, -0.070060, -0.070060, -0.071934, -0.114729, -0.146903, -0.173767, -0.241239, -0.296528, -0.336199, -0.356347, -0.412105, -0.468800, -0.410231, -0.404765
#*# 	-0.021018, -0.185012, -0.204848, -0.155806, -0.132066, -0.134565, -0.127849, -0.100048, -0.102390, -0.080368, -0.123632, -0.157680, -0.178609, -0.233117, -0.285752, -0.312615, -0.327453, -0.374933, -0.396799, -0.343852, -0.334638
#*# 	-0.038667, -0.211876, -0.219998, -0.182982, -0.145810, -0.151745, -0.132066, -0.111605, -0.103171, -0.079119, -0.114260, -0.141749, -0.162834, -0.210939, -0.249517, -0.274194, -0.296528, -0.325423, -0.342759, -0.287001, -0.260137
#*# 	-0.045539, -0.213594, -0.218280, -0.176422, -0.140500, -0.135033, -0.108638, -0.080212, -0.065999, -0.045071, -0.067093, -0.079900, -0.120820, -0.160491, -0.202036, -0.218748, -0.250922, -0.258419, -0.269508, -0.211564, -0.170487
#*# 	-0.069748, -0.228119, -0.223278, -0.167520, -0.133627, -0.115198, -0.091770, -0.059127, -0.028671, -0.013677, -0.035699, -0.061470, -0.068186, -0.116135, -0.140031, -0.174392, -0.193134, -0.204379, -0.216405, -0.142061, -0.082555
#*# 	-0.085522, -0.239521, -0.225152, -0.165645, -0.109887, -0.091614, -0.050381, -0.031795, 0.001473, 0.019746, -0.001183, -0.013834, -0.025860, -0.082399, -0.112855, -0.135189, -0.142999, -0.155181, -0.159554, -0.089271, -0.039292
#*# 	-0.111762, -0.239365, -0.220154, -0.147684, -0.103796, -0.067405, -0.016020, 0.011312, 0.038957, 0.065508, 0.065665, 0.037708, 0.023495, 0.001785, -0.035387, -0.056941, -0.065687, -0.085054, -0.093800, -0.036793, 0.015217
#*# 	-0.184231, -0.281847, -0.268571, -0.176266, -0.106764, -0.055066, -0.026797, 0.023963, 0.063634, 0.104399, 0.075817, 0.069101, 0.063322, 0.032710, 0.008813, -0.019144, -0.037261, -0.056160, -0.053504, 0.018653, 0.048641
#*# 	-0.247642, -0.322924, -0.289656, -0.187824, -0.119102, -0.055691, -0.013833, 0.036302, 0.078003, 0.128763, 0.107210, 0.111115, 0.099557, 0.068632, 0.031773, 0.011625, -0.007118, -0.019300, -0.031795, 0.031616, 0.063478
#*# 	-0.281847, -0.329327, -0.286376, -0.171737, -0.082555, -0.017270, 0.035833, 0.105023, 0.164686, 0.204201, 0.178586, 0.180617, 0.162343, 0.129544, 0.110958, 0.074099, 0.058636, 0.032553, 0.011781, 0.074411, 0.095965
#*# 	-0.287782, -0.338698, -0.266853, -0.140968, -0.036480, 0.028493, 0.084563, 0.168591, 0.224192, 0.263083, 0.251525, 0.257460, 0.248870, 0.216539, 0.167185, 0.143757, 0.125952, 0.100650, 0.074255, 0.126889, 0.141883
#*# 	-0.302932, -0.349319, -0.273257, -0.131753, -0.005243, 0.064571, 0.145631, 0.227629, 0.283855, 0.317747, 0.320402, 0.316342, 0.303534, 0.270736, 0.225911, 0.182960, 0.160469, 0.126733, 0.093153, 0.155940, 0.161562
#*# 	-0.321987, -0.369779, -0.278567, -0.131597, 0.006783, 0.088312, 0.173901, 0.257148, 0.324776, 0.381783, 0.377410, 0.362729, 0.352420, 0.303222, 0.254024, 0.224349, 0.188114, 0.147818, 0.113770, 0.184365, 0.179524
#*# 	-0.339948, -0.399298, -0.284502, -0.128161, 0.024900, 0.123453, 0.227316, 0.313530, 0.402868, 0.450973, 0.445819, 0.439415, 0.419424, 0.362260, 0.293382, 0.263863, 0.224036, 0.183584, 0.148911, 0.200452, 0.204357
#*# 	-0.353380, -0.399454, -0.270289, -0.102859, 0.045829, 0.156408, 0.268861, 0.370382, 0.466748, 0.534532, 0.531877, 0.523912, 0.484397, 0.421142, 0.352577, 0.296819, 0.256991, 0.217008, 0.173120, 0.223099, 0.243403
#*# x_count = 21
#*# y_count = 21
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 45.0
#*# max_x = 975.0
#*# min_y = 20.0
#*# max_y = 900.0
#*#
#*# [probe]
#*# z_offset = 9.302
#*#
#*# [stepper_z]
#*# position_endstop = 7.220
