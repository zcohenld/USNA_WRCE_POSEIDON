[include timelapse.cfg]
[include mainsail.cfg]
[include macros.cfg]
[include klicky-probe.cfg]

##--------------------------------------------------------------------
[mcu]

serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_560055000D51313133353932-if00
restart_method: command

[mcu mcu2]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_260038001550335331383520-if00
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu
##--------------------------------------------------------------------

[printer]
kinematics: cartesian
max_velocity: 300  
max_accel: 500
max_z_velocity: 5
max_z_accel: 180
square_corner_velocity: 5.0

#####################################################################
#   X/Y Stepper Settings
#####################################################################

##  Connected to MOTOR_0
[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 20
microsteps: 32
full_steps_per_rotation:200
endstop_pin: !mcu2:PG6
position_min: 0
position_endstop: 1000
position_max: 1000

homing_speed: 50
homing_retract_dist: 5
homing_positive_dir: true
homing_retract_speed: 25
second_homing_speed: 10


##  Connected to MOTOR_1
[stepper_y]
step_pin: PG0
dir_pin: !PG1
enable_pin: !PF15
rotation_distance: 20
microsteps: 32
full_steps_per_rotation:200
endstop_pin: !PG10
position_min: 0
position_endstop: 0
position_max: 925

homing_speed: 50
homing_retract_dist: 5
homing_positive_dir: false
homing_retract_speed: 25
second_homing_speed: 10


##  Connected to MOTOR_2
[stepper_y1]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
rotation_distance: 20
microsteps: 32
full_steps_per_rotation:200
endstop_pin: !PG9

#####################################################################
#   Z Stepper Settings
#####################################################################

##  Connected to MOTOR_3
#front right
[stepper_z]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: .9995840789  
microsteps: 32
full_steps_per_rotation:200
position_max: 840
position_min: -15
homing_speed: 5
second_homing_speed: 3
homing_retract_dist: 3

endstop_pin: PG6
homing_speed: 15
second_homing_speed: 3
homing_retract_dist: 5
#position_endstop: 10.5


[tmc5160 stepper_z]
cs_pin: PC7
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


##  Connected to MOTOR_4
#front left
[stepper_z1]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
rotation_distance: .9995840789
microsteps: 32
full_steps_per_rotation:200

[tmc5160 stepper_z1]
cs_pin: PF2
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


##  Connected to MOTOR_5
#Back left
[stepper_z2]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: .9995840789 
microsteps: 32
full_steps_per_rotation:200

[tmc5160 stepper_z2]
cs_pin: PE4
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


##  Connected to MOTOR_6
#Back right
[stepper_z3]
step_pin: PE2
dir_pin: !PE3
enable_pin: !PD4
rotation_distance: .9995840789 
microsteps: 32
full_steps_per_rotation:200

[tmc5160 stepper_z3]
cs_pin: PE1
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[endstop_phase]


#####################################################################
#   Extruder
#####################################################################

[thermistor Dyze300]
temperature1: 20
resistance1: 123800
temperature2: 200
resistance2: 550
temperature3: 300
resistance3: 106

[extruder]

step_pin: mcu2:PF13
dir_pin: !mcu2:PF12
enable_pin: !mcu2:PF14

rotation_distance: 31.06  #26.5962159825 

gear_ratio: 5.65:1
microsteps: 16
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: mcu2:PA2


sensor_type: Dyze300
sensor_pin: mcu2:PF3
#spi_speed: 4000000
#spi_software_sclk_pin: mcu2:PA5
#spi_software_mosi_pin: mcu2:PA7
#spi_software_miso_pin: mcu2:PA6

#rtd_nominal_r: 106
#rtd_num_of_wires: 2
#rtd_reference_r: 430
#rtd_use_50Hz_filter: False

min_temp: 10
max_temp: 300
max_power: 1.0
min_extrude_temp: 170
#control = pid
#pid_kp = 19.3
#pid_ki = 2.1
#pid_kd = 44.6

pressure_advance: 0.05
pressure_advance_smooth_time: 0.040

##  E0 on mcu2_MOTOR0
[tmc5160 extruder]
cs_pin: mcu2:PC4
interpolate: false
run_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 0

spi_software_miso_pin: mcu2:PA6
spi_software_mosi_pin: mcu2:PA7
spi_software_sclk_pin: mcu2:PA5


#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PA1
sensor_type: ATC Semitec 104GT-2
sensor_pin: mcu2:PF7

max_power: 1.0
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

[verify_heater heater_bed]
heating_gain: 1.25
check_gain_time: 100

#####################################################################
#   Probe
#####################################################################

[probe]
##  Inductive Probe
pin: ^mcu2:PG9
x_offset: 35.8
y_offset: 16.95
#z_offset: 0
speed: 5.0
samples: 5
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.1
samples_tolerance_retries: 10

#####################################################################
#   Fan Control
#####################################################################

[fan]
pin: mcu2:PE5
kick_start_time: 0.5
off_below: 0.10

[heater_fan hotend_fan]
pin: mcu2:PA8
max_power: 1
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

#####################################################################
#   Lights
#####################################################################

[heater_fan hotend_light]
pin: mcu2:PD13
heater: extruder
heater_temp: 50

[output_pin caselight]
pin: PA2
pwm:true
shutdown_value: 0
value:0.5
cycle_time: 0.001 

[heater_fan bed_light]
pin: mcu2:PD12
heater: heater_bed
heater_temp: 35

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

[bed_screws]
screw1: 50, 50
screw1_name: front left
screw2: 50, 875
screw2_name: back left
screw3: 950, 875
screw3_name: back right
screw4: 950, 50
screw4_name: front right

speed: 100
horizontal_move_z: 25

[bed_mesh]
mesh_min: 45, 20
mesh_max: 975, 900
algorithm: bicubic
probe_count: 21, 21
horizontal_move_z: 20
zero_reference_position: 500, 500

[z_tilt]
z_positions:
  -162, 150
  -162, 800
  1195, 800
  1195, 150

points:
  25, 150
  25, 800
  800, 800
  800, 150

#points:
#  25, 25
#  25, 900
#  950, 900
#  950, 25

speed: 200
horizontal_move_z: 20
retries: 5
retry_tolerance: 0.65

#####################################################################
#   Additional Sensors
#####################################################################

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100 

[temperature_sensor mcu2_temp]
sensor_type: temperature_mcu
sensor_mcu: mcu2
min_temp: 0
max_temp: 100

[filament_switch_sensor FSS_T0]
switch_pin: ^PG12
pause_on_runout: True 
event_delay: 3.0
pause_delay: 0.5
runout_gcode:
    M117 Runout Detected!

[adxl345]
cs_pin: rpi:None

[resonance_tester]
accel_chip: adxl345
probe_points:
    500, 500, 20

[input_shaper]
shaper_freq_x: 44.8
shaper_type_x: zv
shaper_freq_y: 56.2
shaper_type_y: zv

#####################################################################
#   Displays
#####################################################################

#I'll deal with this later (7/6/23)

#--------------------------------------------------------------------

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 71.016
#*# pid_ki = 1.208
#*# pid_kd = 1043.929
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 17.343
#*# pid_ki = 0.605
#*# pid_kd = 124.215
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.003491, -0.122081, -0.120363, -0.046019, -0.009628, 0.000524, 0.001773, 0.029887, 0.047223, 0.049878, -0.011971, -0.064761, -0.158629, -0.276548, -0.388377, -0.481775, -0.561898, -0.648581, -0.745103, -0.754474, -0.756973
#*# 	  -0.093656, -0.227350, -0.227350, -0.157379, -0.132546, -0.134264, -0.126142, -0.099591, -0.088345, -0.098341, -0.171748, -0.220634, -0.293104, -0.408525, -0.513481, -0.595634, -0.677631, -0.761815, -0.844593, -0.840376, -0.849435
#*# 	  -0.160815, -0.296228, -0.304505, -0.247654, -0.238283, -0.248903, -0.243437, -0.222977, -0.220478, -0.238283, -0.301382, -0.327621, -0.398060, -0.502079, -0.586732, -0.656859, -0.731515, -0.799924, -0.894104, -0.888793, -0.911596
#*# 	  -0.243125, -0.365417, -0.391813, -0.332931, -0.324341, -0.335274, -0.331057, -0.315282, -0.311534, -0.330901, -0.390095, -0.435701, -0.495988, -0.577048, -0.660139, -0.729485, -0.778839, -0.838814, -0.938460, -0.913627, -0.926590
#*# 	  -0.324341, -0.452413, -0.481619, -0.445384, -0.419926, -0.429766, -0.448976, -0.441636, -0.424299, -0.421019, -0.464595, -0.529880, -0.585326, -0.657640, -0.720114, -0.779308, -0.824914, -0.897852, -0.977038, -0.951580, -0.938460
#*# 	  -0.376038, -0.511138, -0.537533, -0.498956, -0.479433, -0.495832, -0.498331, -0.481619, -0.488647, -0.494270, -0.537065, -0.583139, -0.620311, -0.716365, -0.750882, -0.801174, -0.841782, -0.902850, -0.971728, -0.944083, -0.935180
#*# 	  -0.427111, -0.566271, -0.596727, -0.555807, -0.536752, -0.551278, -0.545967, -0.528787, -0.526913, -0.529880, -0.564866, -0.590324, -0.625153, -0.690595, -0.747290, -0.778995, -0.822102, -0.875049, -0.917844, -0.890355, -0.861461
#*# 	  -0.465844, -0.627964, -0.647488, -0.613439, -0.585795, -0.607036, -0.573300, -0.551434, -0.542219, -0.542687, -0.591886, -0.592354, -0.626715, -0.683254, -0.734951, -0.765876, -0.800705, -0.826007, -0.881140, -0.822102, -0.789616
#*# 	  -0.496144, -0.662013, -0.677007, -0.639522, -0.594853, -0.630307, -0.600632, -0.580328, -0.557525, -0.582202, -0.577361, -0.609847, -0.623904, -0.668573, -0.719177, -0.737606, -0.759160, -0.789304, -0.815074, -0.777121, -0.722613
#*# 	  -0.486929, -0.655141, -0.659670, -0.634056, -0.591261, -0.594229, -0.571582, -0.529880, -0.549560, -0.500674, -0.526288, -0.556276, -0.593604, -0.622498, -0.665137, -0.727611, -0.708868, -0.742448, -0.741511, -0.697779, -0.627027
#*# 	  -0.514262, -0.663887, -0.668573, -0.630776, -0.591261, -0.573924, -0.547685, -0.530036, -0.495363, -0.472717, -0.494895, -0.514262, -0.525819, -0.596884, -0.618750, -0.642334, -0.650455, -0.661857, -0.667479, -0.612034, -0.544249
#*# 	  -0.539720, -0.681848, -0.676069, -0.612658, -0.577673, -0.547373, -0.524726, -0.490365, -0.463970, -0.431015, -0.462096, -0.480213, -0.487398, -0.564710, -0.575018, -0.604381, -0.616251, -0.607660, -0.616719, -0.570645, -0.500986
#*# 	  -0.565490, -0.681380, -0.689033, -0.607504, -0.560180, -0.536128, -0.521446, -0.448664, -0.426486, -0.390563, -0.408681, -0.414460, -0.426173, -0.466625, -0.495207, -0.501923, -0.531286, -0.568458, -0.569551, -0.491771, -0.444603
#*# 	  -0.626090, -0.714960, -0.708400, -0.614845, -0.552527, -0.514106, -0.479589, -0.423987, -0.375726, -0.364324, -0.366355, -0.368697, -0.386502, -0.414303, -0.447571, -0.481151, -0.486461, -0.489272, -0.507077, -0.453350, -0.413054
#*# 	  -0.694031, -0.775872, -0.736357, -0.651236, -0.567833, -0.519416, -0.483493, -0.421176, -0.393375, -0.325590, -0.361513, -0.359170, -0.366198, -0.394468, -0.411336, -0.431484, -0.450382, -0.464595, -0.484274, -0.431171, -0.383223
#*# 	  -0.704339, -0.791959, -0.733389, -0.639054, -0.536128, -0.479120, -0.439449, -0.358389, -0.338085, -0.272175, -0.307629, -0.294197, -0.303256, -0.341521, -0.370415, -0.369322, -0.375413, -0.410399, -0.429610, -0.382754, -0.347300
#*# 	  -0.729485, -0.789147, -0.724331, -0.596415, -0.514887, -0.431484, -0.380411, -0.306536, -0.238595, -0.196738, -0.226257, -0.204547, -0.216261, -0.237814, -0.279516, -0.302631, -0.307941, -0.353547, -0.382910, -0.327777, -0.309659
#*# 	  -0.758848, -0.794301, -0.715584, -0.576580, -0.455692, -0.383223, -0.306067, -0.235472, -0.168468, -0.136450, -0.138793, -0.138949, -0.150507, -0.187835, -0.231879, -0.260617, -0.266865, -0.320436, -0.344020, -0.300913, -0.280609
#*# 	  -0.780713, -0.818354, -0.708712, -0.590792, -0.448352, -0.362918, -0.299351, -0.203922, -0.127860, -0.086315, -0.093343, -0.090688, -0.103495, -0.135825, -0.185180, -0.219541, -0.256088, -0.282639, -0.321842, -0.293104, -0.230005
#*# 	  -0.800549, -0.837877, -0.733546, -0.571425, -0.435232, -0.321529, -0.241407, -0.154568, -0.080536, -0.023060, -0.018374, -0.036336, -0.031806, -0.095061, -0.139262, -0.180182, -0.223289, -0.271863, -0.305911, -0.249997, -0.217198
#*# 	  -0.819291, -0.833972, -0.715272, -0.555963, -0.419614, -0.291230, -0.195957, -0.093031, -0.010877, 0.067996, 0.063310, 0.053471, 0.029887, -0.024309, -0.084441, -0.130203, -0.184087, -0.222821, -0.259836, -0.214699, -0.191896
#*# x_count = 21
#*# y_count = 21
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 45.0
#*# max_x = 975.0
#*# min_y = 20.0
#*# max_y = 900.0
#*#
#*# [probe]
#*# z_offset = 10.002
#*#
#*# [stepper_z]
#*# position_endstop = 6.425
