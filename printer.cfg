[include timelapse.cfg]
[include mainsail.cfg]
[include macros.cfg]
[include klicky-probe.cfg]

##--------------------------------------------------------------------
[mcu]

serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_560055000D51313133353932-if00
restart_method: command

[mcu mcu2]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_260038001550335331383520-if00
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu
##--------------------------------------------------------------------

[printer]
kinematics: cartesian
max_velocity: 300  
max_accel: 5000
max_z_velocity: 5
max_z_accel: 180
square_corner_velocity: 5.0

#####################################################################
#   X/Y Stepper Settings
#####################################################################

##  Connected to MOTOR_0
[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 20
microsteps: 32
full_steps_per_rotation:200
endstop_pin: !mcu2:PG6
position_min: 0
position_endstop: 1000
position_max: 1000

homing_speed: 50
homing_retract_dist: 5
homing_positive_dir: true
homing_retract_speed: 25
second_homing_speed: 10


##  Connected to MOTOR_1
[stepper_y]
step_pin: PG0
dir_pin: !PG1
enable_pin: !PF15
rotation_distance: 20
microsteps: 32
full_steps_per_rotation:200
endstop_pin: !PG10
position_min: 0
position_endstop: 0
position_max: 925

homing_speed: 50
homing_retract_dist: 5
homing_positive_dir: false
homing_retract_speed: 25
second_homing_speed: 10


##  Connected to MOTOR_2
[stepper_y1]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
rotation_distance: 20
microsteps: 32
full_steps_per_rotation:200
endstop_pin: !PG9

#####################################################################
#   Z Stepper Settings
#####################################################################

##  Connected to MOTOR_3
#front right
[stepper_z]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: .9995840789  
microsteps: 32
full_steps_per_rotation:200
position_max: 840
position_min: -15
homing_speed: 5
second_homing_speed: 3
homing_retract_dist: 3

endstop_pin: PG6
homing_speed: 15
second_homing_speed: 3
homing_retract_dist: 5
#position_endstop: 10.5


[tmc5160 stepper_z]
cs_pin: PC7
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


##  Connected to MOTOR_4
#front left
[stepper_z1]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
rotation_distance: .9995840789
microsteps: 32
full_steps_per_rotation:200

[tmc5160 stepper_z1]
cs_pin: PF2
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


##  Connected to MOTOR_5
#Back left
[stepper_z2]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: .9995840789 
microsteps: 32
full_steps_per_rotation:200

[tmc5160 stepper_z2]
cs_pin: PE4
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


##  Connected to MOTOR_6
#Back right
[stepper_z3]
step_pin: PE2
dir_pin: !PE3
enable_pin: !PD4
rotation_distance: .9995840789 
microsteps: 32
full_steps_per_rotation:200

[tmc5160 stepper_z3]
cs_pin: PE1
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[endstop_phase]


#####################################################################
#   Extruder
#####################################################################

[thermistor Dyze300]
temperature1: 20
resistance1: 123800
temperature2: 200
resistance2: 550
temperature3: 300
resistance3: 106

[extruder]

step_pin: mcu2:PF13
dir_pin: !mcu2:PF12
enable_pin: !mcu2:PF14

rotation_distance: 26.5962159825 

gear_ratio: 5.65:1
microsteps: 16
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: mcu2:PA2


sensor_type: Dyze300
sensor_pin: mcu2:PF3
#spi_speed: 4000000
#spi_software_sclk_pin: mcu2:PA5
#spi_software_mosi_pin: mcu2:PA7
#spi_software_miso_pin: mcu2:PA6

#rtd_nominal_r: 106
#rtd_num_of_wires: 2
#rtd_reference_r: 430
#rtd_use_50Hz_filter: False

min_temp: 10
max_temp: 300
max_power: 1.0
min_extrude_temp: 170
#control = pid
#pid_kp = 19.3
#pid_ki = 2.1
#pid_kd = 44.6

pressure_advance: 0.05
pressure_advance_smooth_time: 0.040

##  E0 on mcu2_MOTOR0
[tmc5160 extruder]
cs_pin: mcu2:PC4
interpolate: false
run_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 0

spi_software_miso_pin: mcu2:PA6
spi_software_mosi_pin: mcu2:PA7
spi_software_sclk_pin: mcu2:PA5


#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PA1
sensor_type: ATC Semitec 104GT-2
sensor_pin: mcu2:PF7

max_power: 1.0
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

[verify_heater heater_bed]
heating_gain: 1.25
check_gain_time: 100

#####################################################################
#   Probe
#####################################################################

[probe]
##  Inductive Probe
pin: ^mcu2:PG9
x_offset: 35.8
y_offset: 16.95
#z_offset: 0
speed: 5.0
samples: 3
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.1
samples_tolerance_retries: 10

#####################################################################
#   Fan Control
#####################################################################

[fan]
pin: mcu2:PE5
kick_start_time: 0.5
off_below: 0.10

[heater_fan hotend_fan]
pin: mcu2:PA8
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

#####################################################################
#   Lights
#####################################################################

[heater_fan hotend_light]
pin: mcu2:PD13
heater: extruder
heater_temp: 50

[output_pin caselight]
pin: PA2
pwm:true
shutdown_value: 0
value:0.5
cycle_time: 0.001 

[heater_fan bed_light]
pin: mcu2:PD12
heater: heater_bed
heater_temp: 35

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

[bed_screws]
screw1: 50, 50
screw1_name: front left
screw2: 50, 875
screw2_name: back left
screw3: 950, 875
screw3_name: back right
screw4: 950, 50
screw4_name: front right

speed: 100
horizontal_move_z: 25

[bed_mesh]
mesh_min: 45, 20
mesh_max: 975, 900
algorithm: bicubic
probe_count: 21, 21
horizontal_move_z: 20
zero_reference_position: 500, 1

[z_tilt]
z_positions:
  -162, 150
  -162, 800
  1195, 800
  1195, 150

points:
  25, 150
  25, 800
  800, 800
  800, 150

#points:
#  25, 25
#  25, 900
#  950, 900
#  950, 25

speed: 200
horizontal_move_z: 20
retries: 5
retry_tolerance: 0.65

#####################################################################
#   Additional Sensors
#####################################################################

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100 

[temperature_sensor mcu2_temp]
sensor_type: temperature_mcu
sensor_mcu: mcu2
min_temp: 0
max_temp: 100

[filament_switch_sensor FSS_T0]
switch_pin: ^PG12
pause_on_runout: True 
event_delay: 3.0
pause_delay: 0.5
runout_gcode:
    M117 Runout Detected!

[adxl345]
cs_pin: rpi:None

[resonance_tester]
accel_chip: adxl345
probe_points:
    500, 500, 20

[input_shaper]
shaper_freq_x: 44.8
shaper_type_x: zv
shaper_freq_y: 56.2
shaper_type_y: zv

#####################################################################
#   Displays
#####################################################################

#I'll deal with this later (7/6/23)

#--------------------------------------------------------------------

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 71.016
#*# pid_ki = 1.208
#*# pid_kd = 1043.929
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 17.343
#*# pid_ki = 0.605
#*# pid_kd = 124.215
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.517764, 0.413076, 0.419326, 0.474639, 0.506514, 0.505576, 0.514951, 0.544014, 0.554951, 0.544014, 0.466826, 0.411201, 0.310264, 0.174639, 0.055889, -0.046611, -0.157236, -0.227549, -0.341924, -0.339424, -0.320361
#*# 	0.418076, 0.275889, 0.268389, 0.340576, 0.366826, 0.357451, 0.362139, 0.378701, 0.382451, 0.352451, 0.287764, 0.219326, 0.135264, 0.018389, -0.088799, -0.182861, -0.250674, -0.328174, -0.429111, -0.417236, -0.412549
#*# 	0.361826, 0.203389, 0.201826, 0.245889, 0.262139, 0.243389, 0.234014, 0.250889, 0.258076, 0.223701, 0.167764, 0.112451, 0.051514, -0.061924, -0.160674, -0.238486, -0.320361, -0.371924, -0.465049, -0.454111, -0.433799
#*# 	0.273701, 0.114014, 0.109951, 0.149326, 0.172764, 0.149014, 0.146514, 0.152451, 0.142451, 0.133389, 0.062451, 0.001826, -0.054111, -0.142236, -0.220361, -0.289424, -0.368174, -0.407236, -0.485049, -0.477236, -0.455361
#*# 	0.186826, 0.031514, 0.008076, 0.045889, 0.061514, 0.044326, 0.039639, 0.055889, 0.050576, 0.017764, -0.055986, -0.084111, -0.133486, -0.209424, -0.281299, -0.347861, -0.405361, -0.456299, -0.518174, -0.491611, -0.462861
#*# 	0.093076, -0.039111, -0.077236, -0.040049, -0.022236, -0.036924, -0.040986, -0.012549, -0.035049, -0.034111, -0.085986, -0.132236, -0.180049, -0.253174, -0.306611, -0.364424, -0.410674, -0.460674, -0.519424, -0.483799, -0.457861
#*# 	0.040889, -0.087236, -0.135361, -0.088174, -0.076924, -0.096924, -0.103174, -0.073486, -0.080986, -0.080986, -0.131299, -0.161299, -0.197236, -0.246924, -0.288799, -0.350049, -0.400986, -0.428486, -0.478486, -0.433174, -0.393486
#*# 	-0.007549, -0.151611, -0.192861, -0.151299, -0.130049, -0.143799, -0.140674, -0.121611, -0.110986, -0.103486, -0.140674, -0.171611, -0.191611, -0.247236, -0.295049, -0.331924, -0.357549, -0.396299, -0.429111, -0.367861, -0.319736
#*# 	-0.034111, -0.181611, -0.211611, -0.166924, -0.153486, -0.151611, -0.150361, -0.126611, -0.103486, -0.097861, -0.125986, -0.146924, -0.170986, -0.203799, -0.253174, -0.291299, -0.311611, -0.336299, -0.358799, -0.299111, -0.244111
#*# 	-0.033799, -0.175674, -0.218486, -0.160674, -0.137861, -0.134424, -0.127861, -0.088799, -0.074736, -0.059424, -0.087861, -0.116299, -0.123174, -0.153799, -0.210986, -0.224736, -0.244736, -0.245986, -0.287549, -0.208174, -0.145986
#*# 	-0.053174, -0.199424, -0.231299, -0.171611, -0.140049, -0.135986, -0.105674, -0.065361, -0.046924, -0.009424, -0.031924, -0.052549, -0.063799, -0.106299, -0.139736, -0.153799, -0.173799, -0.181611, -0.190049, -0.121924, -0.048174
#*# 	-0.092236, -0.226924, -0.246299, -0.180986, -0.140361, -0.116611, -0.084736, -0.044424, -0.002861, 0.019639, -0.001924, -0.025986, -0.013174, -0.060674, -0.101299, -0.112549, -0.132236, -0.140049, -0.139736, -0.069736, 0.007139
#*# 	-0.120674, -0.238799, -0.238486, -0.171299, -0.113799, -0.092549, -0.050049, 0.000264, 0.042139, 0.072764, 0.071201, 0.055264, 0.047764, 0.011826, -0.018486, -0.035674, -0.045361, -0.058799, -0.065361, 0.008076, 0.076826
#*# 	-0.181299, -0.293799, -0.265361, -0.183174, -0.127549, -0.083486, -0.044111, 0.023389, 0.081201, 0.111826, 0.098701, 0.093389, 0.081201, 0.065889, 0.039326, 0.014014, 0.014951, 0.010576, -0.014736, 0.066826, 0.121201
#*# 	-0.261924, -0.363174, -0.314111, -0.224111, -0.138799, -0.095986, -0.034111, 0.031514, 0.075889, 0.121201, 0.112139, 0.103076, 0.110264, 0.092451, 0.068076, 0.042764, 0.047139, 0.037764, 0.014014, 0.073701, 0.144951
#*# 	-0.308174, -0.390049, -0.331924, -0.215361, -0.124736, -0.062236, 0.007139, 0.079326, 0.125576, 0.158701, 0.170576, 0.169951, 0.164951, 0.143389, 0.125889, 0.116826, 0.104014, 0.098701, 0.078701, 0.126514, 0.183389
#*# 	-0.323174, -0.384424, -0.294111, -0.175049, -0.077861, -0.007861, 0.066201, 0.138701, 0.207764, 0.252139, 0.257139, 0.257451, 0.254639, 0.219639, 0.189951, 0.166514, 0.164014, 0.145889, 0.135576, 0.184326, 0.240264
#*# 	-0.355049, -0.406924, -0.334111, -0.181299, -0.061924, 0.025264, 0.100576, 0.185889, 0.260264, 0.311514, 0.309014, 0.318389, 0.313389, 0.275889, 0.248389, 0.224951, 0.207764, 0.195576, 0.167764, 0.216201, 0.274326
#*# 	-0.380986, -0.425674, -0.332861, -0.172861, -0.050361, 0.049639, 0.129014, 0.218701, 0.310889, 0.364951, 0.364951, 0.375576, 0.366201, 0.327139, 0.309639, 0.277139, 0.244639, 0.219326, 0.189639, 0.238076, 0.288389
#*# 	-0.430674, -0.449111, -0.362549, -0.182861, -0.044736, 0.073389, 0.159951, 0.274951, 0.352451, 0.418389, 0.416826, 0.423701, 0.424326, 0.372139, 0.332451, 0.311201, 0.286514, 0.250889, 0.223389, 0.285889, 0.324326
#*# 	-0.441924, -0.452861, -0.346924, -0.168174, -0.030986, 0.095576, 0.201514, 0.327764, 0.421201, 0.499639, 0.508389, 0.509326, 0.489951, 0.433701, 0.406201, 0.356826, 0.321514, 0.294639, 0.263701, 0.311826, 0.353076
#*# x_count = 21
#*# y_count = 21
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 45.0
#*# max_x = 975.0
#*# min_y = 20.0
#*# max_y = 900.0
#*#
#*# [probe]
#*# z_offset = 7.002
#*#
#*# [stepper_z]
#*# position_endstop = 10.00
